{"title":"Is setState asynchronous?","uid":"d7e769e271f05380381ff271e09b897f","slug":"async-setState","date":"2023-02-07T20:07:27.000Z","updated":"2023-02-15T23:38:03.061Z","comments":true,"path":"api/articles/async-setState.json","keywords":null,"cover":null,"content":"<h2 id=\"Ideas-of-this-article\"><a href=\"#Ideas-of-this-article\" class=\"headerlink\" title=\"Ideas of this article\"></a>Ideas of this article</h2><p>SetState itself is <strong>not an asynchronous</strong> function, but for some reasons React makes setState <strong>act like an async</strong> function.</p>\n<p>This article will:</p>\n<ol>\n<li>summarize why setState() act like an async function.</li>\n<li>discuss what makes synchronous setState() to act asynchronously</li>\n<li>provide an example to tell why async or sync setState matters</li>\n</ol>\n<h2 id=\"Why-setState-act-like-an-async-function\"><a href=\"#Why-setState-act-like-an-async-function\" class=\"headerlink\" title=\"Why setState() act like an async function\"></a>Why setState() act like an async function</h2><p>We expect synchronous calls to be executed immediately, while asynchronous calls to be executed after a while.</p>\n<p><strong>In daily life, what kind of things you will do immediately, and what you will do later?</strong></p>\n<p>Obviously, things that are done immediately usually have higher priority, and things delayed are more likely to be less important. Similarly, what we trigger with setState is not always with top priority.</p>\n<p>Here comes the first reason to make setState act in an asynchronous way: <strong>priority scheduling</strong>. </p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>React could assign different priorities to setState() calls depending on where they’re coming from: an event handler, a network response, an animation, etc.<br>– Dan Abramov</p></blockquote>\n<h3 id=\"Reason-1-ensures-concurrent-features\"><a href=\"#Reason-1-ensures-concurrent-features\" class=\"headerlink\" title=\"Reason 1: ensures concurrent features\"></a>Reason 1: ensures concurrent features</h3><p><strong>Example</strong><br>Assume you are receiving a bunch of notification messages, while editing a post on social media.</p>\n<p><strong>What happens if the notification updates were immediately executed?</strong> </p>\n<p>You may not be annoyed by this when there are only a few messages. But if there are 100+ or even 1000+ new messages, your keyboard input can be very sluggish, as the browser is busy updating new notifications.</p>\n<p><strong>For the above situation, what can you do to ensure smooth text input for users?</strong></p>\n<p>A good practice is: giving low priority to message updates which are not important in this case. And when a message update encounters a high priority event, we will ask the former one to yield the main thread.</p>\n<p><strong>Why asynchronous setState() benefits prioritized rendering (concurrent features) in React?</strong><br>Asynchronous-like setState() makes concurrent features possible. </p>\n<p>This is because async-like setState() makes it easier to delay execution of low priority task and make room for high priority ones.</p>\n<p>To further understand concurrent features, you can go to <a href=\"https://flaming-cl.github.io/post/simple-ideas-about-React-Concurrent-mode\">this post</a></p>\n<h3 id=\"Reason-2-avoid-dirty-data\"><a href=\"#Reason-2-avoid-dirty-data\" class=\"headerlink\" title=\"Reason 2: avoid dirty data\"></a>Reason 2: avoid dirty data</h3><p>Besides performance optimization, avoiding dirty data is another reason for us to avoid running setState() in an synchronous way.</p>\n<p>To understand this, we need to talk about the core value of React first.</p>\n<p><strong>React In Theory</strong></p>\n<p>For React, its most fundamental principle evolved from this formula:</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>UI &#x3D; f(state)</p></blockquote>\n<p>The idea behind it is simple: <strong>same input states result in same UI</strong>.</p>\n<p>However, based on Dan Abramov’s explanation, running setState() synchronously may violate React’s pure-function-like update processes.</p>\n<p><strong>Why running synchronous setState() may violate the core value of React?</strong></p>\n<p>Because it is hard to ensure consistency on synchronously updated states and their props.</p>\n<p>States are often not isolated but come with props. To ensure consistent data flow, once you immediately update a state, you also need to update its related props in time.</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>However, even though you may immediately update a state, props only update after the reconciliation and flushing.</p></blockquote>\n<p>For example, although a parent component updates a state immediately, the state related props received by children have to wait until reconciliation or flushing finished.</p>\n<p><strong>Such inconsistency can lead to dirty data.</strong></p>\n<h2 id=\"What-makes-sync-setState-act-asynchronously\"><a href=\"#What-makes-sync-setState-act-asynchronously\" class=\"headerlink\" title=\"What makes sync setState() act asynchronously\"></a>What makes sync setState() act asynchronously</h2>","feature":true,"text":"Ideas of this articleSetState itself is not an asynchronous function, but for some reasons React makes setState act like an async function. ...","link":"","photos":[],"count_time":{"symbolsCount":"3.4k","symbolsTime":"3 mins."},"categories":[],"tags":[{"name":"React","slug":"React","count":5,"path":"api/tags/React.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Ideas-of-this-article\"><span class=\"toc-text\">Ideas of this article</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Why-setState-act-like-an-async-function\"><span class=\"toc-text\">Why setState() act like an async function</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Reason-1-ensures-concurrent-features\"><span class=\"toc-text\">Reason 1: ensures concurrent features</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Reason-2-avoid-dirty-data\"><span class=\"toc-text\">Reason 2: avoid dirty data</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#What-makes-sync-setState-act-asynchronously\"><span class=\"toc-text\">What makes sync setState() act asynchronously</span></a></li></ol>","author":{"name":"flaming-cl","slug":"flaming-cl","avatar":"https://avatars.githubusercontent.com/u/51183663?s=400&u=7addc16053694c5fa5d328409bb44dc2d4d18e4a&v=4","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Single-threaded JavaScript","uid":"e3fb0e6e7c44f4a9d38a4589b5569d51","slug":"single-threaded-javascript","date":"2023-02-08T19:33:14.000Z","updated":"2023-02-15T23:40:13.182Z","comments":true,"path":"api/articles/single-threaded-javascript.json","keywords":null,"cover":[],"text":"Single-threaded JavaScriptThe JavaScript engine is single threaded. This means it only does one thing at a time in the call stack, like the ...","link":"","photos":[],"count_time":{"symbolsCount":"1.7k","symbolsTime":"2 mins."},"categories":[],"tags":[{"name":"JavaScript","slug":"JavaScript","count":1,"path":"api/tags/JavaScript.json"}],"author":{"name":"flaming-cl","slug":"flaming-cl","avatar":"https://avatars.githubusercontent.com/u/51183663?s=400&u=7addc16053694c5fa5d328409bb44dc2d4d18e4a&v=4","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"Questions About React concurrent features","uid":"fb9f2e7d2bf6b72bb67731a251124487","slug":"simple-ideas-about-React-Concurrent-mode","date":"2023-02-06T17:21:10.000Z","updated":"2023-02-09T03:15:05.304Z","comments":true,"path":"api/articles/simple-ideas-about-React-Concurrent-mode.json","keywords":null,"cover":[],"text":"Do React concurrent features mean multitasking? No. React concurrent features are not about multitasking. This is because the JavaScript eng...","link":"","photos":[],"count_time":{"symbolsCount":"2.3k","symbolsTime":"2 mins."},"categories":[],"tags":[{"name":"React","slug":"React","count":5,"path":"api/tags/React.json"}],"author":{"name":"flaming-cl","slug":"flaming-cl","avatar":"https://avatars.githubusercontent.com/u/51183663?s=400&u=7addc16053694c5fa5d328409bb44dc2d4d18e4a&v=4","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true}}