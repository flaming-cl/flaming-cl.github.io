{"title":"React Source Code Little by Little 1 -  Time Slicing","uid":"aae100d7d9b058fd9820b29b99447c0a","slug":"time-slicing-react","date":"2022-09-28T22:49:47.000Z","updated":"2023-03-24T22:21:59.736Z","comments":true,"path":"api/articles/time-slicing-react.json","keywords":null,"cover":[],"content":"<p>You may have heard people saying “React is fast” as it uses virtual DOM.<br>But is virtual DOM the only thing you can think of when talking about React performance?<br>In fact React has done many things to handle performance issues.</p>\n<p>Today I will talk about Time Slicing.<br>A technique React uses to solve performance bottleneck.</p>\n<h2 id=\"Event-Loop-and-CPU-bottlenecks\"><a href=\"#Event-Loop-and-CPU-bottlenecks\" class=\"headerlink\" title=\"Event Loop and CPU bottlenecks\"></a>Event Loop and CPU bottlenecks</h2><h3 id=\"Event-Loop\"><a href=\"#Event-Loop\" class=\"headerlink\" title=\"Event Loop\"></a>Event Loop</h3><p>Modern browsers run a continuous event loop at a certain frequency - e.g. 60Hz (refresh 60 times a second). For smooth and responsive experience, browsers try to complete tasks within each event loop execution, aka a frame.</p>\n<p><img src=\"https://user-images.githubusercontent.com/51183663/209892101-70af523b-4bf5-45ba-9aef-b01ac11f9b70.png\" alt=\"event-loop-frame\"></p>\n<p>For 60Hz refresh rate devices, each execution frame has a budget of 16.66ms (1 second &#x2F; 60).</p>\n<h3 id=\"CPU-bottlenecks\"><a href=\"#CPU-bottlenecks\" class=\"headerlink\" title=\"CPU bottlenecks\"></a>CPU bottlenecks</h3><p>Within such a shoestring budget, browsers have to handle a pipeline of work like this:</p>\n<p><img src=\"https://user-images.githubusercontent.com/51183663/209890234-985a0618-b856-414d-999e-f41823756b9b.png\" alt=\"frame_pipeline\"></p>\n<p>If any step in this pipeline needs more than 16.66ms, no time will be left for the upcoming work in this frame.<br>This means we will not have time for style calculations, layout, paint and compositing, when we spend too much time on JavaScript jobs.<br>When this lasts for 2 or 3 seconds, users will feel your website is slow.</p>\n<h3 id=\"How-does-React-avoid-this-scenario\"><a href=\"#How-does-React-avoid-this-scenario\" class=\"headerlink\" title=\"How does React avoid this scenario?\"></a>How does React avoid this scenario?</h3><p>React sets up an interval for running JavaScript tasks (5ms).<br>When running out of this interval, React will pause its current tasks and give back control to the main thread, letting it perform high priority tasks (painting or user events).<br>After the main thread has finished prioritized jobs, React goes back to where it stopped and continues working.</p>\n<p>As you may have noticed, the key here is to make React interruptible.</p>\n<h2 id=\"Time-Slicing-and-Interruptible-React\"><a href=\"#Time-Slicing-and-Interruptible-React\" class=\"headerlink\" title=\"Time Slicing and Interruptible React\"></a>Time Slicing and Interruptible React</h2><p>Assume we have a large application with 500+ components to render.</p>\n<h3 id=\"While-rendering-these-components-how-does-React-ensure-responsiveness-for-keyboard-or-mouse-events\"><a href=\"#While-rendering-these-components-how-does-React-ensure-responsiveness-for-keyboard-or-mouse-events\" class=\"headerlink\" title=\"While rendering these components, how does React ensure responsiveness for keyboard or mouse events?\"></a>While rendering these components, how does React ensure responsiveness for keyboard or mouse events?</h3><p>Before React 16, the render phase was synchronize and uninterruptible.<br>The browser therefore would be easily occupied by CPU-hungry tasks,<br>and unable to give prompt responses to user events.<br>Take a look at <a href=\"https://www.youtube.com/watch?v=nLF0n9SACd4\">this video</a> to see what CPU-heavy tasks could be like.</p>\n<h3 id=\"So-how-did-React-overcome-this\"><a href=\"#So-how-did-React-overcome-this\" class=\"headerlink\" title=\"So, how did React overcome this?\"></a>So, how did React overcome this?</h3><p>Answer: Time Slicing.</p>\n<p>Here is a <a href=\"https://twitter.com/acdlite/status/977291318324948992\">picture</a> of time slicing in React (idea of Andrew Clark from the React core team).</p>\n<p><img src=\"https://user-images.githubusercontent.com/51183663/211950568-f4b85e7a-91d6-4a5a-9b97-c949a14e4282.png\" alt=\"time_slicing\"></p>\n<h3 id=\"Interruptible-render-phase\"><a href=\"#Interruptible-render-phase\" class=\"headerlink\" title=\"Interruptible render phase\"></a>Interruptible render phase</h3><p>After version 16, React started using Fiber reconciler to ensure the render phase is interruptible. It breaks down the render phase into time slices so that it can pause current work to run more urgent tasks, like user inputs.<br>As shown in the above picture, time slicing enables browser events to cut in line during the render phase. This helps React to avoid “hiccup” moments.</p>\n<h3 id=\"Uninterruptible-commit-phase\"><a href=\"#Uninterruptible-commit-phase\" class=\"headerlink\" title=\"Uninterruptible commit phase\"></a>Uninterruptible commit phase</h3><p>Unlike the render phase, the commit phase can not be interrupted.<br>You can think of these two like a movie screenplay and a movie on show.<br>When a movie is on (the commit phase), theatres will not suddenly stop playing or change its order of scenes. Just like React will not draw some semi-calculated UI or suddenly stop the commit phase.</p>\n<h2 id=\"Interruptible-Work-Loop\"><a href=\"#Interruptible-Work-Loop\" class=\"headerlink\" title=\"Interruptible Work Loop\"></a>Interruptible Work Loop</h2><p>Before version 16, React reconciler is implemented by call stack recursion. However, stack Reconciliation will not allow pauses on the running render phase.<br>As mentioned earlier, a high performance render phase is time sliced and interruptible. To implement this, we can change the call stack recursion to conditional while loop recursion:</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">deadline</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">let</span> shouldYield <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>shouldYield<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// next workInprogress is set within performUnitOfWork</span>\n        <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>\n            workInProgress \n        <span class=\"token punctuation\">)</span>\n        shouldYield <span class=\"token operator\">=</span> deadline<span class=\"token punctuation\">.</span><span class=\"token function\">timeRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">1</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span>workLoop<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>while (workInProgress !&#x3D;&#x3D; null &amp;&amp; !shouldYield)<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>This enables us to stop the workLoop, especially when there is no time left in each frame (shouldYield).  </p></blockquote>\n</li>\n<li>requestIdleCallback<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>Check whether the main thread is idle for running sliced tasks.</p></blockquote>\n</li>\n</ul>\n<h2 id=\"Fiber-Reconciler\"><a href=\"#Fiber-Reconciler\" class=\"headerlink\" title=\"Fiber Reconciler\"></a>Fiber Reconciler</h2><p>This interruptable reconciler is called Fiber reconciler in React.<br>To know more about React Fiber, take a look at this post first: <a href=\"https://flaming-cl.github.io/post/react-fiber-tree\">React Fiber Tree</a>.</p>\n<h2 id=\"References\"><a href=\"#References\" class=\"headerlink\" title=\"References\"></a>References</h2><p>[1] <a href=\"https://reactjs.org/blog/2018/03/01/sneak-peek-beyond-react-16.html\">Sneak Peek: Beyond React 16, Dan Abramov</a><br>[1] <a href=\"https://pomb.us/build-your-own-react/\">Build your own React, Rodrigo Pombo</a><br>[2] <a href=\"https://javascript.info/event-loop\">Event loop: microtasks and macrotasks, javascript.info</a><br>[3] <a href=\"https://twitter.com/acdlite/status/977291318324948992\">Visualization of async rendering and synchronous rendering in React, Andrew Clark</a><br>[4] <a href=\"https://reactjs.org/docs/reconciliation.html\">Reconciliation, React official documents</a><br>[5] <a href=\"https://web.dev/rendering-performance/\">Rendering Performance, Paul Lewis</a><br>[6] <a href=\"https://www.w3.org/TR/frame-timing/\">Frame timing, W3C</a></p>\n","text":"You may have heard people saying “React is fast” as it uses virtual DOM.But is virtual DOM the only thing you can think of when talking abou...","link":"","photos":[],"count_time":{"symbolsCount":"4.4k","symbolsTime":"4 mins."},"categories":[],"tags":[{"name":"React","slug":"React","count":7,"path":"api/tags/React.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Event-Loop-and-CPU-bottlenecks\"><span class=\"toc-text\">Event Loop and CPU bottlenecks</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Event-Loop\"><span class=\"toc-text\">Event Loop</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#CPU-bottlenecks\"><span class=\"toc-text\">CPU bottlenecks</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#How-does-React-avoid-this-scenario\"><span class=\"toc-text\">How does React avoid this scenario?</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Time-Slicing-and-Interruptible-React\"><span class=\"toc-text\">Time Slicing and Interruptible React</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#While-rendering-these-components-how-does-React-ensure-responsiveness-for-keyboard-or-mouse-events\"><span class=\"toc-text\">While rendering these components, how does React ensure responsiveness for keyboard or mouse events?</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#So-how-did-React-overcome-this\"><span class=\"toc-text\">So, how did React overcome this?</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Interruptible-render-phase\"><span class=\"toc-text\">Interruptible render phase</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Uninterruptible-commit-phase\"><span class=\"toc-text\">Uninterruptible commit phase</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Interruptible-Work-Loop\"><span class=\"toc-text\">Interruptible Work Loop</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Fiber-Reconciler\"><span class=\"toc-text\">Fiber Reconciler</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#References\"><span class=\"toc-text\">References</span></a></li></ol>","author":{"name":"flaming-cl","slug":"flaming-cl","avatar":"https://avatars.githubusercontent.com/u/51183663?s=400&u=7addc16053694c5fa5d328409bb44dc2d4d18e4a&v=4","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Exploring the Benefits of Locality in Memory","uid":"87eff45d285eb86c0eaa49c27b6abfb9","slug":"locality","date":"2022-11-10T18:04:15.000Z","updated":"2023-03-24T22:25:36.401Z","comments":true,"path":"api/articles/locality.json","keywords":null,"cover":null,"text":"As stated in Computer Systems: A Programmer’s Perspective: Well-written computer programs tend to exhibit good locality What is localityIf y...","link":"","photos":[],"count_time":{"symbolsCount":"4.9k","symbolsTime":"4 mins."},"categories":[],"tags":[{"name":"Memory","slug":"Memory","count":1,"path":"api/tags/Memory.json"}],"author":{"name":"flaming-cl","slug":"flaming-cl","avatar":"https://avatars.githubusercontent.com/u/51183663?s=400&u=7addc16053694c5fa5d328409bb44dc2d4d18e4a&v=4","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{}}