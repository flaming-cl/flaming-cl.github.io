{"title":"Why is setState asynchronous?","uid":"a73bcd9e3cea561f6b21201f5df43298","slug":"async-setState","date":"2023-02-07T20:07:27.000Z","updated":"2023-02-09T02:05:29.499Z","comments":true,"path":"api/articles/async-setState.json","keywords":null,"cover":null,"content":"<p>This is a reflection on Dan Abramov’s answer in the RFClarification: why is setState asynchronous.</p>\n<h2 id=\"What\"><a href=\"#What\" class=\"headerlink\" title=\"What\"></a>What</h2><p>Before figuring out why synchronous or asynchronous, I want to explain what they mean first.</p>\n<h3 id=\"What-is-asynchronous-and-what-is-synchronous\"><a href=\"#What-is-asynchronous-and-what-is-synchronous\" class=\"headerlink\" title=\"What is asynchronous and what is synchronous?\"></a>What is asynchronous and what is synchronous?</h3><p>To put it simply, we expect synchronous calls to be executed immediately, while asynchronous calls will be executed after a while.</p>\n<h3 id=\"In-daily-life-what-kind-of-things-would-you-do-immediately-and-what-would-you-do-later\"><a href=\"#In-daily-life-what-kind-of-things-would-you-do-immediately-and-what-would-you-do-later\" class=\"headerlink\" title=\"In daily life, what kind of things would you do immediately, and what would you do later?\"></a>In daily life, what kind of things would you do immediately, and what would you do later?</h3><p>Obviously, things that are done immediately usually have higher priority, and things that are delayed are usually less important.</p>\n<p>Similarly, what you trigger with setState is not always the most urgent, or may even be <abbr>insignificant</abbr>. So why update it immediately in a synchronous way?</p>\n<h2 id=\"Reason-1-ensures-concurrent-features\"><a href=\"#Reason-1-ensures-concurrent-features\" class=\"headerlink\" title=\"Reason 1: ensures concurrent features\"></a>Reason 1: ensures concurrent features</h2><h3 id=\"Example\"><a href=\"#Example\" class=\"headerlink\" title=\"Example\"></a>Example</h3><p>Assume you are editing a post on social media. Meanwhile, you are receiving a bunch of notification messages.</p>\n<h3 id=\"What-if-the-notification-updates-were-immediately-executed\"><a href=\"#What-if-the-notification-updates-were-immediately-executed\" class=\"headerlink\" title=\"What if the notification updates were immediately executed?\"></a>What if the notification updates were immediately executed?</h3><p>You may not be annoyed by this, when there are only a few messages. But if there are 100+ or even 1000+ new messages, your keyboard input can become sluggish, as the browser is busy with immediately processed (synchronous) new messages.</p>\n<h3 id=\"For-the-above-situation-what-can-you-do-to-ensure-smooth-text-input-for-users\"><a href=\"#For-the-above-situation-what-can-you-do-to-ensure-smooth-text-input-for-users\" class=\"headerlink\" title=\"For the above situation, what can you do to ensure smooth text input for users?\"></a>For the above situation, what can you do to ensure smooth text input for users?</h3><p>The solution is simple: give low priority to the message updates. When a message update encounters a high priority event, we will ask the former one to yield the main thread.</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>React could assign different priorities to setState() calls depending on where they’re coming from: an event handler, a network response, an animation, etc.</p></blockquote>\n<h3 id=\"What-is-relationship-between-asynchronous-setState-calls-and-concurrent-features\"><a href=\"#What-is-relationship-between-asynchronous-setState-calls-and-concurrent-features\" class=\"headerlink\" title=\"What is relationship between asynchronous setState calls and concurrent features?\"></a>What is relationship between asynchronous setState calls and concurrent features?</h3><p>It is the asynchronous feature of setState that makes concurrent features (rendering with priorities) possible. If all the setState calls are executed immediately, it is not easy for us to delay its execution and make room for high priority tasks.</p>\n<p>To future understand benefits of concurrent features, you can go to <a href=\"https://flaming-cl.github.io/bits-refinery/bits-refinery/2023/02/06/simple-ideas-about-React-Concurrent-mode/\">this post</a></p>\n<h2 id=\"Reason-2-avoid-dirty-data\"><a href=\"#Reason-2-avoid-dirty-data\" class=\"headerlink\" title=\"Reason 2: avoid dirty data\"></a>Reason 2: avoid dirty data</h2><p>Besides performance concern, dirty data is another potential cost of synchronous setState.<br>To understand this, we need to talk about the core value of React first.</p>\n<h3 id=\"React-In-Theory\"><a href=\"#React-In-Theory\" class=\"headerlink\" title=\"React In Theory\"></a>React In Theory</h3><p>For React, its most fundamental principle evolved from this formula:</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>UI &#x3D; f(state)</p></blockquote>\n<p>The idea behind it is simple: same state data leads to same UI.<br>However, based on Dan’s explanation, immediately executing setState may violate React’s pure function-like update process:</p>\n<h3 id=\"Why-synchronous-setState-may-violate-the-core-theory-of-React\"><a href=\"#Why-synchronous-setState-may-violate-the-core-theory-of-React\" class=\"headerlink\" title=\"Why synchronous setState may violate the core theory of React?\"></a>Why synchronous setState may violate the core theory of React?</h3><p>It is hard to ensure consistency on synchronously updated states and their props.</p>\n<p>To ensure consistent data flow, once you immediately update a state, you also need to update its related props in time.</p>\n<p>Unfortunately, there is no quick solution to such requirement.</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>You may immediately update a state, but props only update after the reconciliation and flushing.</p></blockquote>\n<p>So it is possible that a parent component updates one of its states immediately, but the related props received by children component have not changed yet.<br>Such inconsistency can lead to dirty data.</p>\n","text":"This is a reflection on Dan Abramov’s answer in the RFClarification: why is setState asynchronous. WhatBefore figuring out why synchronous o...","link":"","photos":[],"count_time":{"symbolsCount":"3.1k","symbolsTime":"3 mins."},"categories":[],"tags":[{"name":"React","slug":"React","count":5,"path":"api/tags/React.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#What\"><span class=\"toc-text\">What</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#What-is-asynchronous-and-what-is-synchronous\"><span class=\"toc-text\">What is asynchronous and what is synchronous?</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#In-daily-life-what-kind-of-things-would-you-do-immediately-and-what-would-you-do-later\"><span class=\"toc-text\">In daily life, what kind of things would you do immediately, and what would you do later?</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Reason-1-ensures-concurrent-features\"><span class=\"toc-text\">Reason 1: ensures concurrent features</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Example\"><span class=\"toc-text\">Example</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#What-if-the-notification-updates-were-immediately-executed\"><span class=\"toc-text\">What if the notification updates were immediately executed?</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#For-the-above-situation-what-can-you-do-to-ensure-smooth-text-input-for-users\"><span class=\"toc-text\">For the above situation, what can you do to ensure smooth text input for users?</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#What-is-relationship-between-asynchronous-setState-calls-and-concurrent-features\"><span class=\"toc-text\">What is relationship between asynchronous setState calls and concurrent features?</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Reason-2-avoid-dirty-data\"><span class=\"toc-text\">Reason 2: avoid dirty data</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#React-In-Theory\"><span class=\"toc-text\">React In Theory</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Why-synchronous-setState-may-violate-the-core-theory-of-React\"><span class=\"toc-text\">Why synchronous setState may violate the core theory of React?</span></a></li></ol></li></ol>","author":{"name":"flaming-cl","slug":"flaming-cl","avatar":"https://avatars.githubusercontent.com/u/51183663?s=400&u=7addc16053694c5fa5d328409bb44dc2d4d18e4a&v=4","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Single-threaded JavaScript","uid":"e3fb0e6e7c44f4a9d38a4589b5569d51","slug":"single-threaded-javascript","date":"2023-02-08T19:33:14.000Z","updated":"2023-02-09T02:05:44.256Z","comments":true,"path":"api/articles/single-threaded-javascript.json","keywords":null,"cover":[],"text":"Single-threaded JavaScriptThe JavaScript engine is single threaded. This means it only does one thing at a time in the call stack, like the ...","link":"","photos":[],"count_time":{"symbolsCount":"1.7k","symbolsTime":"2 mins."},"categories":[],"tags":[{"name":"JavaScript","slug":"JavaScript","count":1,"path":"api/tags/JavaScript.json"}],"author":{"name":"flaming-cl","slug":"flaming-cl","avatar":"https://avatars.githubusercontent.com/u/51183663?s=400&u=7addc16053694c5fa5d328409bb44dc2d4d18e4a&v=4","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Questions About React concurrent features","uid":"fb9f2e7d2bf6b72bb67731a251124487","slug":"simple-ideas-about-React-Concurrent-mode","date":"2023-02-06T17:21:10.000Z","updated":"2023-02-08T20:26:15.000Z","comments":true,"path":"api/articles/simple-ideas-about-React-Concurrent-mode.json","keywords":null,"cover":[],"text":"Do React concurrent features mean multitasking? No. React concurrent features are not about multitasking. This is because the JavaScript eng...","link":"","photos":[],"count_time":{"symbolsCount":"2.3k","symbolsTime":"2 mins."},"categories":[],"tags":[{"name":"React","slug":"React","count":5,"path":"api/tags/React.json"}],"author":{"name":"flaming-cl","slug":"flaming-cl","avatar":"https://avatars.githubusercontent.com/u/51183663?s=400&u=7addc16053694c5fa5d328409bb44dc2d4d18e4a&v=4","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}